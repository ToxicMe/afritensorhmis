{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="max-w-6xl mx-auto mt-8">
  <h2 class="text-xl font-bold mb-4 text-blue-800">Prescription Note</h2>

  <div class="mb-4 text-sm">
    <p><strong>Patient:</strong> {{ visit.patient.get_full_name|default:visit.patient.username }}</p>
    <p><strong>Tracking Code:</strong> {{ visit.tracking_code }}</p>
    <p><strong>Visit Date:</strong> {{ visit.date_time|date:"Y-m-d H:i" }}</p>
    <p><strong>Hospital:</strong> {{ visit.hospital.name }}</p>
  </div>

  {% if prescription %}
  <div class="bg-white border p-4 rounded shadow mb-8">
    <p class="text-gray-700 whitespace-pre-line">{{ prescription.doctor_prescription }}</p>
    <p class="text-xs text-gray-500 mt-2">Prescribed by: {{ prescription.done_by.get_full_name|default:prescription.done_by.username }}</p>
  </div>
  {% else %}
  <p class="text-red-500">No prescription note found.</p>
  {% endif %}
</div>

<!-- Add Item to Sale -->
<div class="max-w-6xl mx-auto bg-gray-50 border p-4 rounded">
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="add_item" />

    <h3 class="text-lg font-semibold mb-4 text-blue-700">Add Drug to Sale</h3>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm mb-1">Product</label>
        <input type="text" id="searchProduct" placeholder="Search product..." class="w-full px-3 py-2 border rounded">
        <select name="product_id" id="productSelect" class="w-full mt-1 px-3 py-2 border rounded">
          {% for product in products %}
            <option value="{{ product.id }}">{{ product.name }} (KES {{ product.price }}, {{ product.quantity }} in stock)</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm mb-1">Quantity</label>
        <input type="number" name="quantity" min="1" class="w-full px-3 py-2 border rounded" required />
      </div>
      <div>
        <label class="block text-sm mb-1">Dosage / Notes</label>
        <input type="text" name="description" class="w-full px-3 py-2 border rounded" />
      </div>
    </div>

    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add to Sale</button>
  </form>
</div>

<!-- Finalize Button -->
<div class="max-w-6xl mx-auto text-right mt-6">
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="finalize" />
    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
      Finalize & Bill
    </button>
  </form>
</div>

<!-- Messages -->
{% if messages %}
<div class="max-w-6xl mx-auto mt-4">
  {% for message in messages %}
    <div class="p-3 rounded text-sm bg-{{ message.tags }}-100 text-{{ message.tags }}-800 mb-2">
      {{ message }}
    </div>
  {% endfor %}
</div>
{% endif %}

<!-- JavaScript for live product filter -->
<script>
  const searchInput = document.getElementById("searchProduct");
  const productSelect = document.getElementById("productSelect");

  searchInput.addEventListener("keyup", function () {
    const search = this.value.toLowerCase();
    for (const option of productSelect.options) {
      const text = option.text.toLowerCase();
      option.style.display = text.includes(search) ? "block" : "none";
    }
  });
</script>

{% endblock %}
