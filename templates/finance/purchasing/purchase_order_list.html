{% extends 'base.html' %}
{% block content %}


  {% if messages %}
    <div class="popup-form">
      {% for message in messages %}
        <p style="color:red;">{{ message }}</p>
      {% endfor %}
    </div>
  {% endif %}

<div class="max-w-8xl mx-auto mt-10 bg-white shadow p-6 rounded-lg">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-blue-700">Purchase Orders</h2>
   <a href="javascript:void(0)" onclick="document.getElementById('newPurchaseModal').classList.remove('hidden')"
   class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
  + New Purchase Order
</a>
  </div>



<!-- Modal -->
<div id="newPurchaseModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl">
    <div class="flex justify-between items-center border-b px-6 py-4">
      <h3 class="text-xl font-semibold text-blue-700">New Purchase Order</h3>
      <button onclick="document.getElementById('newPurchaseModal').classList.add('hidden')"
              class="text-gray-600 hover:text-red-600 text-2xl leading-none">&times;</button>
    </div>

    <form method="POST" action="{% url 'purchase_order_create' %}" class="p-6 space-y-6">
      {% csrf_token %}
      <div class="grid grid-cols-2 gap-4">

        <div>
          <label class="block text-sm font-medium text-gray-700">Supplier</label>
          <select name="supplier" required class="mt-1 w-full px-3 py-2 border rounded">
            <option value="">-- Select Supplier --</option>
            {% for supplier in suppliers %}
              <option value="{{ supplier.id }}">{{ supplier.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Requisition </label>
          <select name="requisition" id="requisitionSelect" class="mt-1 w-full px-3 py-2 border rounded">
            <option value="">-- None --</option>
            {% for req in requisitions %}
                <option 
                value="{{ req.id }}" 
                data-total="{{ req.total_cost }}" 
                data-location="{{ req.done_by.profile.hospital.name|default:'' }}"
                >
                {{ req.requisition_id }} - {{ req.date_of_request }}
                </option>
            {% endfor %}
            </select>

        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Expected Delivery Date</label>
          <input type="date" name="expected_delivery_date" required class="mt-1 w-full px-3 py-2 border rounded" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Total Amount</label>
          <input type="number" step="0.01" name="total_amount" id="totalAmount" required class="mt-1 w-full px-3 py-2 border rounded" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Payment Terms</label>
          <input name="payment_terms" type="text" class="mt-1 w-full px-3 py-2 border rounded" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Delivery Location</label>
          <input type="text" name="delivery_location" id="deliveryLocation" class="mt-1 w-full px-3 py-2 border rounded" />

        </div>

        <div class="col-span-2">
          <label class="block text-sm font-medium text-gray-700">Notes</label>
          <textarea name="notes" rows="3" class="w-full mt-1 px-3 py-2 border rounded"></textarea>
        </div>
      </div>

      <div class="flex justify-end space-x-2">
        <button type="button" onclick="document.getElementById('newPurchaseModal').classList.add('hidden')"
                class="px-4 py-2 border rounded text-gray-600">Cancel</button>
        <button type="submit"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Submit</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const requisitionSelect = document.getElementById('requisitionSelect');
    const totalAmountInput = document.getElementById('totalAmount');
    const deliveryLocationInput = document.getElementById('deliveryLocation');

    requisitionSelect.addEventListener('change', function () {
      const selectedOption = this.options[this.selectedIndex];
      const total = selectedOption.getAttribute('data-total');
      const location = selectedOption.getAttribute('data-location');

      if (total) totalAmountInput.value = total;
      if (location) deliveryLocationInput.value = location;
    });
  });


console.log("Total:", total);
console.log("Location:", location);
</script>





  <!-- Filter Form -->
  <form method="get" class="mb-4 grid grid-cols-1 md:grid-cols-8 gap-4">
    <select name="supplier" class="border px-3 py-2 rounded text-sm">
      <option value="">All Suppliers</option>
      {% for supplier in suppliers %}
        <option value="{{ supplier.id }}" {% if supplier.id|stringformat:"s" == filter_supplier %}selected{% endif %}>
          {{ supplier.name }}
        </option>
      {% endfor %}
    </select>

    <select name="status" class="border px-3 py-2 rounded text-sm">
      <option value="">All Statuses</option>
      <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pending</option>
      <option value="approved" {% if filter_status == 'approved' %}selected{% endif %}>Approved</option>
      <option value="received" {% if filter_status == 'received' %}selected{% endif %}>Received</option>
      <option value="cancelled" {% if filter_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
    </select>

    <button type="submit" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">Filter</button>
  </form>

<div class="max-w-8xl mx-auto mt-10 bg-white shadow p-6 rounded-lg">

  <table class="min-w-full border border-gray-200 text-sm">
    <thead class="bg-gray-100 text-blue-600">
      <tr>
        <th class="px-4 py-2 border">PO Number</th>
        <th class="px-4 py-2 border">Supplier</th>
        <th class="px-4 py-2 border">Order Date</th>
        <th class="px-4 py-2 border">Expected Delivery</th>
        <th class="px-4 py-2 border">Total</th>
        <th class="px-4 py-2 border">Status</th>
        <th class="px-4 py-2 border">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100 text-gray-700">
      {% for po in page_obj %}
      <tr class="hover:bg-gray-50">
        <td class="px-4 py-2 border font-medium">{{ po.po_number }}</td>
        <td class="px-4 py-2 border">{{ po.supplier.name }}</td>
        <td class="px-4 py-2 border">{{ po.order_date }}</td>
        <td class="px-4 py-2 border">{{ po.expected_delivery_date }}</td>
        <td class="px-4 py-2 border">KES {{ po.total_amount|floatformat:2 }}</td>
        <td class="px-4 py-2 border capitalize">{{ po.status }}</td>
        <td class="px-4 py-2 border">
          <a href="{% url 'purchase_order_detail' po.pk %}" class="text-blue-600 hover:underline">View</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="text-center py-4 text-gray-500">No purchase orders found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="mt-6 flex justify-between items-center">
  <div class="text-sm text-gray-600">
    Showing {{ page_obj.start_index }}â€“{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
  </div>
  <div class="space-x-2">
    {% if page_obj.has_previous %}
      <a href="?{% if filter_supplier %}supplier={{ filter_supplier }}&{% endif %}
                 {% if filter_status %}status={{ filter_status }}&{% endif %}
                 page={{ page_obj.previous_page_number }}"
         class="px-3 py-1 border rounded text-sm text-gray-700 hover:bg-gray-100">Previous</a>
    {% endif %}

    {% if page_obj.has_next %}
      <a href="?{% if filter_supplier %}supplier={{ filter_supplier }}&{% endif %}
                 {% if filter_status %}status={{ filter_status }}&{% endif %}
                 page={{ page_obj.next_page_number }}"
         class="px-3 py-1 border rounded text-sm text-gray-700 hover:bg-gray-100">Next</a>
    {% endif %}
  </div>
</div>
</div>
{% endblock %}
