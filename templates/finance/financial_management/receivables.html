{% extends "base.html" %}
{% block content %}

{% if messages %}
  <div class="my-4">
    {% for message in messages %}
      <div class="text-sm p-2 mb-2 rounded 
                  {% if message.tags == 'error' %}bg-red-100 text-red-700
                  {% elif message.tags == 'success' %}bg-green-100 text-green-700
                  {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700
                  {% else %}bg-blue-100 text-blue-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="max-w-8xl mt-12 mx-auto bg-white p-6 rounded shadow">

  <h1 class="text-2xl font-bold mb-6 text-gray-700">Insurance Receivables</h1>

  <!-- Header: Search + Summary -->
  <div class="flex flex-col gap-6 md:flex-row justify-between mb-6">

    <!-- Filter Form -->
    <form method="get" action="{% url 'receivables' %}" class="flex flex-wrap items-end gap-4 w-full md:w-2/3">

      <!-- Start Date -->
      <div>
        <label class="block text-sm text-gray-600 mb-1">Start Date</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="border px-3 py-2 rounded text-sm">
      </div>

      <!-- End Date -->
      <div>
        <label class="block text-sm text-gray-600 mb-1">End Date</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="border px-3 py-2 rounded text-sm">
      </div>

      <!-- Status -->
      <div>
        <label class="block text-sm text-gray-600 mb-1">Status</label>
        <select name="status" class="border px-3 py-2 rounded text-sm">
          <option value="">All</option>
          <option value="paid" {% if status == "paid" %}selected{% endif %}>Paid</option>
          <option value="pending" {% if status == "pending" %}selected{% endif %}>Pending</option>
          <option value="cancelled" {% if status == "cancelled" %}selected{% endif %}>Cancelled</option>
          <option value="disputed" {% if status == "disputed" %}selected{% endif %}>Disputed</option>
        </select>
      </div>

      <!-- Submit -->
      <div>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 mt-1">
          Apply Filter
        </button>
      </div>

      <!-- Search Input -->
      <div class="bg-white flex px-4 py-3 border-b border-[#333] focus-within:border-blue-500 overflow-hidden max-w-md mx-auto">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192.904 192.904" width="18px" class="fill-gray-600 mr-3">
          <path
            d="m190.707 180.101-47.078-47.077c11.702-14.072 18.752-32.142 18.752-51.831C162.381 36.423 125.959 0 81.191 0 36.422 0 0 36.423 0 81.193c0 44.767 36.422 81.187 81.191 81.187 19.688 0 37.759-7.049 51.831-18.751l47.079 47.078a7.474 7.474 0 0 0 5.303 2.197 7.498 7.498 0 0 0 5.303-12.803zM15 81.193C15 44.694 44.693 15 81.191 15c36.497 0 66.189 29.694 66.189 66.193 0 36.496-29.692 66.187-66.189 66.187C44.693 147.38 15 117.689 15 81.193z">
          </path>
        </svg>
        <input type="text" name="q" placeholder="Invoice no | Customer name" value="{{ query }}" class="w-full outline-none text-sm" />
      </div>
    </form>

    <!-- Summary Card -->
    <div class="w-full md:w-1/3 flex flex-col sm:flex-row gap-4">
      <div class="bg-blue-50 text-blue-800 p-4 rounded shadow-sm text-sm w-full sm:w-full">
        <div class="font-medium text-gray-500">Total Insurance Billed</div>
        <div class="text-xl font-bold">KES {{ total_insurance_amount|floatformat:2 }}</div>
      </div>
    </div>
  </div>

  <!-- Insurance Bills Table -->
  <table class="min-w-full border border-gray-200 divide-y mt-6 divide-gray-200 text-sm">
    <thead class="bg-blue-600 text-left text-white">
      <tr>
        <th class="px-4 py-2">#</th>
        <th class="px-4 py-2">Customer Name</th>
        <th class="px-4 py-2">Invoice Number</th>
        <th class="px-4 py-2">Invoice Date</th>
        <th class="px-4 py-2">Amount</th>
        <th class="px-4 py-2">Status</th>
        <th class="px-4 py-2">Action</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% for bill in insurance_bills %}
      <tr class="hover:bg-gray-50">
        <td class="px-4 py-2">{{ forloop.counter }}</td>
        <td class="px-4 py-2">{{ bill.patient.get_full_name }}</td>
        <td class="px-4 py-2">{{ bill.transaction_id }}</td>
        <td class="px-4 py-2">{{ bill.date|date:"F d, Y" }}</td>
        <td class="px-4 py-2">KES {{ bill.amount }}</td>
        <td class="px-4 py-2 capitalize">{{ bill.status }}</td>
        <td class="px-4 py-2">
          <a href="{% url 'receivables_details' bill.id %}" class="text-blue-600 hover:underline">View</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="text-center text-gray-500 py-4">No insurance bills found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

</div>

{% endblock %}
