{% extends "base.html" %}
{% block content %}

<div class="max-w-8xl mt-12 mx-auto bg-white shadow-md rounded-lg p-6 space-y-8">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Cash Journal</h1>
      <p class="text-sm text-gray-500 mt-1">Cash inflows and outflows</p>
    </div>
    <button id="openModalBtn"
      class="bg-blue-600 text-white px-5 py-2.5 rounded-md text-sm font-medium hover:bg-blue-700 transition">
      + Add Entry
    </button>
  </div>

  <!-- Add Entry Modal -->
  <div id="addEntryModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 items-center justify-center">
    <div class="bg-white w-full max-w-xl rounded-lg shadow-lg p-6 relative">
      <h2 class="text-lg font-bold mb-4 text-gray-800">Add Journal Entry</h2>
      <form method="post" action="{% url 'add_petty_cash_entry' %}">
        {% csrf_token %}
        <div class="grid grid-cols-2 gap-4">

          <!-- Debit Ledger -->
          <div>
            <label class="text-sm text-gray-600">Debit Ledger Account<span class="text-red-600"><sup>*</sup></span></label>
            <select name="debit_ledger_account" class="select2 w-full border rounded px-3 py-2" required>
              <option value="">Select</option>
              {% for cashaccount in cash_accounts_list %}
                <option value="{{ cashaccount.name }}">{{ cashaccount.name }} - {{ cashaccount.balance }} - {{ cashaccount.hospital }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Credit Ledger -->
          <div>
            <label class="text-sm text-gray-600">Credit Ledger Account<span class="text-red-600"><sup>*</sup></span></label>
            <select name="credit_ledger_account" class="select2 w-full border rounded px-3 py-2" required>
              <option value="">Select</option>
              {% for cashaccount in cash_accounts_list %}
                <option value="{{ cashaccount.name }}">{{ cashaccount.name }} - {{ cashaccount.balance }} - {{ cashaccount.hospital }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Posting Date -->
          <div class="col-span-2">
            <label class="text-sm text-gray-600">Posting Date & Time <span class="text-red-600"><sup>*</sup></span></label>
            <input type="datetime-local" name="posting_date" id="posting-datetime" readonly required class="w-full border rounded px-3 py-2">
          </div>

          <!-- Document Date -->
          <div>
            <label class="text-sm text-gray-600">Document Date <span class="text-red-600"><sup>*</sup></span></label>
            <input type="date" name="Document_date" required class="w-full border rounded px-3 py-2">
          </div>

          <!-- Document Type -->
          <div>
            <label class="text-sm text-gray-600">Document Type</label>
            <input type="text" name="Document_type" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Document No -->
          <div>
            <label class="text-sm text-gray-600">Document No</label>
            <input type="text" name="Document_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- External Document No -->
          <div>
            <label class="text-sm text-gray-600">External Document No</label>
            <input type="text" name="External_document_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Account Type -->
          <div>
            <label class="text-sm text-gray-600">Account Type</label>
            <input type="text" name="Acc_type" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Account No -->
          <div>
            <label class="text-sm text-gray-600">Account No</label>
            <input type="text" name="Acc_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Description -->
          <div class="col-span-2">
            <label class="text-sm text-gray-600">Description</label>
            <textarea name="description" class="w-full border rounded px-3 py-2"></textarea>
          </div>

          <!-- Debit Amount -->
          <div>
            <label class="text-sm text-gray-600">Debit Amount</label>
            <input type="number" step="0.01" name="debit_amount" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Credit Amount -->
          <div>
            <label class="text-sm text-gray-600">Credit Amount</label>
            <input type="number" step="0.01" name="credit_amount" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Balance Account Type -->
          <div>
            <label class="text-sm text-gray-600">Balance Account Type</label>
            <input type="text" name="balance_acc_type" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Balance Account No -->
          <div>
            <label class="text-sm text-gray-600">Balance Account No</label>
            <input type="text" name="balance_acc_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Branch Code -->
          <div>
            <label class="text-sm text-gray-600">Branch Code</label>
            <input type="text" name="branch_code" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Department Code -->
          <div>
            <label class="text-sm text-gray-600">Department Code</label>
            <input type="text" name="department_code" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Line No (auto-generated) -->
          <div>
            <label class="text-sm text-gray-600">Line No</label>
            <input type="text" name="line_no" id="line_no" class="w-full border rounded px-3 py-2" readonly>
          </div>

          <!-- Entry Type -->
          

        </div>

        <div class="mt-6 flex justify-end gap-4">
          <button type="button" id="cancelModalBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Petty Cash Entries Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border text-sm text-gray-800 mt-6">
        <thead class="bg-blue-600 text-white">
            <tr>
                <th class="py-2 px-3 border">Posting Date</th>
                <th class="py-2 px-3 border">Document Date</th>
                <th class="py-2 px-3 border">Document Type</th>
                <th class="py-2 px-3 border">Document No</th>
                <th class="py-2 px-3 border">External Doc No</th>
                <th class="py-2 px-3 border">Acc Type</th>
                <th class="py-2 px-3 border">Acc No</th>
                <th class="py-2 px-3 border">Description</th>
                <th class="py-2 px-3 border text-right">Debit</th>
                <th class="py-2 px-3 border text-right">Credit</th>
                <th class="py-2 px-3 border">Balance Acc Type</th>
                <th class="py-2 px-3 border">Balance Acc No</th>
                <th class="py-2 px-3 border">Branch Code</th>
                <th class="py-2 px-3 border">Dept Code</th>
                <th class="py-2 px-3 border">Line No</th>
                <th class="py-2 px-3 border text-center">Action</th>
            </tr>
        </thead>
        <tbody>
        {% for entry in entries %}
        <tr>
            <td class="border px-3 py-1">{{ entry.posting_date }}</td>
            <td class="border px-3 py-1">{{ entry.document_date }}</td>
            <td class="border px-3 py-1">{{ entry.document_type|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.document_no|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.external_document_no|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.acc_type|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.acc_no|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.description|default:"-" }}</td>
            <td class="border px-3 py-1 text-right">{{ entry.debit_amount|floatformat:2 }}</td>
            <td class="border px-3 py-1 text-right">{{ entry.credit_amount|floatformat:2 }}</td>
            <td class="border px-3 py-1">{{ entry.balance_acc_type|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.balance_acc_no|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.branch_code|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.department_code|default:"-" }}</td>
            <td class="border px-3 py-1">{{ entry.line_no|default:"-" }}</td>
            <td class="border px-3 py-1 text-center">
                <button type="button"
                        class="text-blue-600 hover:underline text-xs view-entry-btn"
                        data-entry-id="{{ entry.id }}">
                    View
                </button>
                <script type="application/json" id="entry_{{ entry.id }}">
                    {{ entry|safe|json_script:"entry_" }}
                </script>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="16" class="text-center py-4 text-gray-500">No petty cash entries yet.</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
  </div>

  <!-- Back Button -->
  <div class="mt-6 text-center">
    <a href="{% url 'accounting' %}">
      <button type="button"
        class="px-5 py-2.5 rounded-lg text-sm tracking-wider font-semibold border-2 border-gray-700 bg-transparent hover:bg-gray-700 hover:text-white transition-all duration-300">
        Back
      </button>
    </a>
  </div>

</div>

<!-- Entry Details Modal -->
<div id="entryDetailsModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 items-center justify-center">
  <div class="bg-white w-full max-w-lg rounded-lg shadow-lg p-6 relative">
    <h2 class="text-lg font-bold mb-4 text-gray-800">Petty Cash Entry Details</h2>
    <div id="entryDetailsContent" class="text-sm text-gray-800 space-y-1"></div>
    <div class="mt-6 flex justify-end">
      <button type="button" id="closeEntryModal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  // Modal open/close
  const openModalBtn = document.getElementById("openModalBtn");
  const cancelModalBtn = document.getElementById("cancelModalBtn");
  const modal = document.getElementById("addEntryModal");
  openModalBtn.addEventListener("click", () => { modal.classList.remove("hidden"); modal.classList.add("flex"); });
  cancelModalBtn.addEventListener("click", () => { modal.classList.add("hidden"); modal.classList.remove("flex"); });
  window.addEventListener("click", e => { if (e.target === modal) { modal.classList.add("hidden"); modal.classList.remove("flex"); } });

  // Select2
  $(document).ready(function () { $('.select2').select2({ width: '100%' }); });

  // Autofill current datetime
  window.addEventListener("DOMContentLoaded", function () {
    const dtInput = document.getElementById("posting-datetime");
    const now = new Date();
    const formatted = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0,16);
    dtInput.value = formatted;
    dtInput.min = formatted;
  });

  // Auto-generate line number
  function generateLineNo() {
    const lineNo = 'LN-' + Math.floor(100000 + Math.random() * 900000);
    document.getElementById('line_no').value = lineNo;
  }
  document.addEventListener('DOMContentLoaded', generateLineNo);

  // Entry Details Modal
  const entryModal = document.getElementById('entryDetailsModal');
  const entryContent = document.getElementById('entryDetailsContent');
  const closeBtn = document.getElementById('closeEntryModal');

  document.querySelectorAll('.view-entry-btn').forEach(button => {
    button.addEventListener('click', function() {
        const entryId = this.dataset.entryId;
        const entryData = JSON.parse(document.getElementById('entry_' + entryId).textContent);

        entryContent.innerHTML = `
            <p><strong>Posting Date:</strong> ${entryData.posting_date}</p>
            <p><strong>Document Date:</strong> ${entryData.document_date}</p>
            <p><strong>Document Type:</strong> ${entryData.document_type || '-'}</p>
            <p><strong>Document No:</strong> ${entryData.document_no || '-'}</p>
            <p><strong>External Doc No:</strong> ${entryData.external_document_no || '-'}</p>
            <p><strong>Debit Ledger:</strong> ${entryData.debit_ledger_account}</p>
            <p><strong>Credit Ledger:</strong> ${entryData.credit_ledger_account}</p>
            <p><strong>Acc Type:</strong> ${entryData.acc_type || '-'}</p>
            <p><strong>Acc No:</strong> ${entryData.acc_no || '-'}</p>
            <p><strong>Description:</strong> ${entryData.description || '-'}</p>
            <p><strong>Debit Amount:</strong> ${parseFloat(entryData.debit_amount).toFixed(2)}</p>
            <p><strong>Credit Amount:</strong> ${parseFloat(entryData.credit_amount).toFixed(2)}</p>
            <p><strong>Balance Acc Type:</strong> ${entryData.balance_acc_type}</p>
            <p><strong>Balance Acc No:</strong> ${entryData.balance_acc_no}</p>
            <p><strong>Branch Code:</strong> ${entryData.branch_code || '-'}</p>
            <p><strong>Department Code:</strong> ${entryData.department_code || '-'}</p>
            <p><strong>Line No:</strong> ${entryData.line_no || '-'}</p>
            
            <p><strong>Done By:</strong> ${entryData.done_by}</p>
        `;

        entryModal.classList.remove('hidden');
        entryModal.classList.add('flex');
    });
  });

  closeBtn.addEventListener('click', () => {
    entryModal.classList.add('hidden');
    entryModal.classList.remove('flex');
  });
</script>

{% endblock %}
