{% extends "base.html" %}
{% block content %}

<div class="max-w-8xl mt-12 mx-auto bg-white shadow-md rounded-lg p-6 space-y-8">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Petty Cash Journal</h1>
      <p class="text-sm text-gray-500 mt-1">Cash inflows and outflows</p>
    </div>
    <button id="openModalBtn"
      class="bg-blue-600 text-white px-5 py-2.5 rounded-md text-sm font-medium hover:bg-blue-700 transition">
      + Add Entry
    </button>
  </div>

  <!-- Modal Form -->
  <div id="addEntryModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 items-center justify-center">
    <div class="bg-white w-full max-w-xl rounded-lg shadow-lg p-6 relative">
      <h2 class="text-lg font-bold mb-4 text-gray-800">Add Journal Entry</h2>
      <form method="post" action="{% url 'add_petty_cash_entry' %}">
        {% csrf_token %}
        <div class="grid grid-cols-2 gap-4">

          <!-- Debit Ledger -->
          <div>
            <label class="text-sm text-gray-600">Debit Ledger Account<span class="text-red-600"><sup>*</sup></span></label>
            <select name="debit_ledger_account" class="select2 w-full border rounded px-3 py-2" required>
              <option value="">Select</option>
              {% for cashaccount in cash_accounts_list %}
                <option value="{{ cashaccount.name }}">{{ cashaccount.name }} - {{ cashaccount.balance }} - {{ cashaccount.hospital }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Credit Ledger -->
          <div>
            <label class="text-sm text-gray-600">Credit Ledger Account<span class="text-red-600"><sup>*</sup></span></label>
            <select name="credit_ledger_account" class="select2 w-full border rounded px-3 py-2" required>
              <option value="">Select</option>
              {% for cashaccount in cash_accounts_list %}
                <option value="{{ cashaccount.name }}">{{ cashaccount.name }} - {{ cashaccount.balance }} - {{ cashaccount.hospital }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Posting Date -->
          <div class="col-span-2">
            <label class="text-sm text-gray-600">Posting Date & Time <span class="text-red-600"><sup>*</sup></span></label>
            <input type="datetime-local" name="posting_date" id="posting-datetime" required class="w-full border rounded px-3 py-2">
          </div>

          <!-- Document Date -->
          <div>
            <label class="text-sm text-gray-600">Document Date <span class="text-red-600"><sup>*</sup></span></label>
            <input type="date" name="Document_date" required class="w-full border rounded px-3 py-2">
          </div>

          <!-- Document Type -->
          <div>
            <label class="text-sm text-gray-600">Document Type</label>
            <input type="text" name="Document_type" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Document No -->
          <div>
            <label class="text-sm text-gray-600">Document No</label>
            <input type="text" name="Document_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- External Document No -->
          <div>
            <label class="text-sm text-gray-600">External Document No</label>
            <input type="text" name="External_document_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Account Type -->
          <div>
            <label class="text-sm text-gray-600">Account Type</label>
            <input type="text" name="Acc_type" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Account No -->
          <div>
            <label class="text-sm text-gray-600">Account No</label>
            <input type="text" name="Acc_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Description -->
          <div class="col-span-2">
            <label class="text-sm text-gray-600">Description</label>
            <textarea name="description" class="w-full border rounded px-3 py-2"></textarea>
          </div>

          <!-- Debit Amount -->
          <div>
            <label class="text-sm text-gray-600">Debit Amount</label>
            <input type="number" step="0.01" name="debit_amount" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Credit Amount -->
          <div>
            <label class="text-sm text-gray-600">Credit Amount</label>
            <input type="number" step="0.01" name="credit_amount" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Balance Account Type -->
          <div>
            <label class="text-sm text-gray-600">Balance Account Type</label>
            <input type="text" name="balance_acc_type" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Balance Account No -->
          <div>
            <label class="text-sm text-gray-600">Balance Account No</label>
            <input type="text" name="balance_acc_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Branch Code -->
          <div>
            <label class="text-sm text-gray-600">Branch Code</label>
            <input type="text" name="branch_code" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Department Code -->
          <div>
            <label class="text-sm text-gray-600">Department Code</label>
            <input type="text" name="department_code" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Line No -->
          <div>
            <label class="text-sm text-gray-600">Line No</label>
            <input type="text" name="line_no" class="w-full border rounded px-3 py-2">
          </div>

          <!-- Entry Type -->
          <div>
            <label class="text-sm text-gray-600">Entry Type</label>
            <select name="entry_type" class="w-full border rounded px-3 py-2">
              <option value="">Select</option>
              <option value="debit">Debit (Cash In)</option>
              <option value="credit">Credit (Cash Out)</option>
            </select>
          </div>

        </div>

        <div class="mt-6 flex justify-end gap-4">
          <button type="button" id="cancelModalBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full border text-sm text-gray-800 mt-6">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="py-2 px-3 border">Posting Date</th>
          <th class="py-2 px-3 border">Document Date</th>
          <th class="py-2 px-3 border">Document Type</th>
          <th class="py-2 px-3 border">Document No</th>
          <th class="py-2 px-3 border">External Document No</th>
          <th class="py-2 px-3 border">Acc Type</th>
          <th class="py-2 px-3 border">Acc No</th>
          <th class="py-2 px-3 border">Description</th>
          <th class="py-2 px-3 border">Debit Amount</th>
          <th class="py-2 px-3 border">Credit Amount</th>
          <th class="py-2 px-3 border">Bal Acc Type</th>
          <th class="py-2 px-3 border">Bal Acc No</th>
          <th class="py-2 px-3 border">Branch Code</th>
          <th class="py-2 px-3 border">Dept Code</th>
          <th class="py-2 px-3 border">Line No</th>
          <th class="py-2 px-3 border text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in entries %}
        <tr>
          <td class="border px-3 py-2">{{ entry.posting_date|date:"Y-m-d H:i" }}</td>
          <td class="border px-3 py-2">{{ entry.Document_date|date:"Y-m-d" }}</td>
          <td class="border px-3 py-2">{{ entry.Document_type|default:"-" }}</td>
          <td class="border px-3 py-2">{{ entry.Document_no|default:"-" }}</td>
          <td class="border px-3 py-2">{{ entry.External_document_no|default:"-" }}</td>
          <td class="border px-3 py-2 capitalize">{{ entry.Acc_type|default:"-" }}</td>
          <td class="border px-3 py-2 text-right">{{ entry.Acc_no|default:"-" }}</td>
          <td class="border px-3 py-2">{{ entry.description|default:"-" }}</td>
          <td class="border px-3 py-2 text-right">{{ entry.debit_amount|default_if_none:0|floatformat:2 }}</td>
          <td class="border px-3 py-2 text-right">{{ entry.credit_amount|default_if_none:0|floatformat:2 }}</td>
          <td class="border px-3 py-2">{{ entry.balance_acc_type|default:"-" }}</td>
          <td class="border px-3 py-2">{{ entry.balance_acc_no|default:"-" }}</td>
          <td class="border px-3 py-2">{{ entry.branch_code|default:"-" }}</td>
          <td class="border px-3 py-2">{{ entry.department_code|default:"-" }}</td>
          <td class="border px-3 py-2">{{ entry.line_no|default:"-" }}</td>
          <td class="border px-3 py-2 text-center">
            <a href="#" class="text-blue-600 hover:underline text-sm">View</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="16" class="text-center py-4">No entries found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Back Button -->
  <div class="mt-6 text-center">
    <a href="{% url 'accounting' %}">
      <button type="button"
        class="px-5 py-2.5 rounded-lg text-sm tracking-wider font-semibold border-2 border-gray-700 bg-transparent hover:bg-gray-700 hover:text-white transition-all duration-300">
        Back
      </button>
    </a>
  </div>

</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  // Modal open/close
  const openModalBtn = document.getElementById("openModalBtn");
  const cancelModalBtn = document.getElementById("cancelModalBtn");
  const modal = document.getElementById("addEntryModal");

  openModalBtn.addEventListener("click", () => {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  });
  cancelModalBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  });
  window.addEventListener("click", e => {
    if (e.target === modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  });

  // Select2
  $(document).ready(function () {
    $('.select2').select2({ width: '100%' });
  });

  // Autofill current datetime
  window.addEventListener("DOMContentLoaded", function () {
    const dtInput = document.getElementById("posting-datetime");
    const now = new Date();
    const formatted = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                          .toISOString().slice(0,16);
    dtInput.value = formatted;
    dtInput.min = formatted;
    dtInput.dispatchEvent(new Event('change'));
  });
</script>

{% endblock %}
