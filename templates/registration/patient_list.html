{% extends "base.html" %}

{% block content %}

{% if messages %}
  <div class="my-4">
    {% for message in messages %}
      <div class="text-sm p-2 mb-2 rounded 
                  {% if message.tags == 'error' %}bg-red-100 text-red-700
                  {% elif message.tags == 'success' %}bg-green-100 text-green-700
                  {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700
                  {% else %}bg-blue-100 text-blue-700{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="overflow-x-auto">
  <table class="min-w-full bg-white">
    <thead class="bg-blue-600 whitespace-nowrap">
      <tr>
        <th class="p-4 text-left text-[13px] font-semibold text-gray-100">Station</th>
        <th class="p-4 text-left text-[13px] font-semibold text-gray-100">Patient Name</th>
        <th class="p-4 text-left text-[13px] font-semibold text-gray-100">Gender</th>
        <th class="p-4 text-left text-[13px] font-semibold text-gray-100">Age</th>
        <th class="p-4 text-left text-[13px] font-semibold text-gray-100">Date of Registration</th>
        <th class="p-4 text-left text-[13px] font-semibold text-gray-100">Actions</th>
      </tr>
    </thead>
    <tbody class="whitespace-nowrap">
      {% for patient in patients %}
      <tr class="hover:bg-gray-50">
        <td class="p-4 text-[15px] text-slate-900 font-medium">{{ patient.hospital.name }}</td>
        <td class="p-4 text-[15px] text-slate-600 font-medium">{{ patient.patient_name }}</td>
        <td class="p-4 text-[15px] text-slate-600 font-medium">{{ patient.gender }}</td>
<td class="p-4 text-[15px] text-slate-600 font-medium" id="age"
    data-dob="{{ patient.date_of_birth|date:'Y-m-d' }}">
  {% if patient.date_of_birth %}
    {{ patient.date_of_birth|date:"Y-m-d" }} (calculating age...)
  {% else %}
    N/A
  {% endif %}
</td>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const ageCell = document.getElementById("age");
  if (!ageCell) return;

  // Read DOB from data attribute (YYYY-MM-DD) â€” safer than embedding raw template into JS string
  const dob = ageCell.dataset.dob;
  console.log("DOB from template:", dob); // debugging

  if (!dob) {
    ageCell.textContent = "N/A";
    return;
  }

  // Basic validation & parse
  const parts = dob.split("-");
  if (parts.length !== 3) {
    console.warn("Unexpected DOB format:", dob);
    ageCell.textContent = dob;
    return;
  }

  const year = parseInt(parts[0], 10);
  const month = parseInt(parts[1], 10) - 1; // JS months are 0-based
  const day = parseInt(parts[2], 10);

  const birth = new Date(year, month, day);
  if (isNaN(birth.getTime())) {
    console.warn("Invalid date parsed:", dob);
    ageCell.textContent = "N/A";
    return;
  }

  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
    age--;
  }

  ageCell.textContent = age + " yrs";
});
</script>


        <td class="p-4 text-[15px] text-slate-600 font-medium">{{ patient.date_of_registration }}</td>
        <td class="p-4">
          <div class="space-x-2 space-y-2 text-center flex flex-col sm:flex-row sm:items-center sm:justify-center">

            <!-- New Visit -->
            <button type="button"
              onclick="openVisitModal({{ patient.id }})"
              class="px-5 py-2.5 rounded-lg text-sm tracking-wider font-semibold border-2 border-blue-700 bg-transparent hover:bg-blue-700 text-blue-700 hover:text-white transition">
              New Visit
            </button>

           

            <!-- View Full Info -->
            <a href="{% url 'view_patient' patient.id %}">
              <button type="button"
                class="px-5 py-2.5 rounded-lg text-sm tracking-wider font-semibold border-2 border-indigo-600 bg-transparent hover:bg-indigo-600 text-indigo-600 hover:text-white transition">
                View
              </button>
            </a>

          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="4" class="text-center py-4 text-gray-500">No patients found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= NEW VISIT MODAL ================= -->
<div id="visitModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-lg relative">

    <button id="closeVisitModal" class="absolute top-2 right-4 text-xl text-gray-700 hover:text-red-500">&times;</button>

    <h3 class="text-xl font-semibold text-gray-800 mb-6">Create New Visit</h3>

            <form id="visitForm" method="POST" action="{% url 'create_visit' %}">
            {% csrf_token %}

            <!-- Patient ID -->
            <input type="hidden" id="visitPatientId" name="patient_id" value="">

            <!-- Visit Type -->
            <div class="mb-4">
              <label class="block text-sm font-medium mb-1">Visit Type</label>
              <select name="type" class="w-full border px-3 py-2 rounded" required>
                <option value="outpatient">Outpatient</option>
                <option value="outpatient_consultation">Consultation</option>
                <option value="minor_surgery">Minor Surgery</option>
              </select>
            </div>

            <!-- Discount Checkbox -->
            <div class="mb-4">
              <label class="inline-flex items-center">
                <input type="checkbox" id="discountedCheckbox" name="discounted" value="yes" class="form-checkbox text-blue-600">
                <span class="ml-2 text-sm text-gray-700">Discounted</span>
              </label>
            </div>

            <!-- Discounted Amount (initially hidden) -->
            <div class="mb-4 hidden" id="discountAmountContainer">
              <label class="block text-sm font-medium mb-1">Amount to be billed</label>
              <input type="number" step="0.01" name="discounted_amount" placeholder="Enter discounted fee"
                    class="w-full border px-3 py-2 rounded">
            </div>

            <!-- Discount Reason (initially hidden) -->
            <div class="mb-4 hidden" id="discountReasonContainer">
              <label class="block text-sm font-medium mb-1">Reason for Discount</label>
              <textarea name="discount_reason" rows="2" placeholder="e.g. Welfare support, staff benefit"
                        class="w-full border px-3 py-2 rounded"></textarea>
            </div>

            <!-- Submit Button -->
            <div class="text-right">
              <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                Create Visit
              </button>
            </div>
        </form>


  </div>
</div>

<!-- ================= MODAL SCRIPT ================= -->
<script>
  const discountedCheckbox = document.getElementById('discountedCheckbox');
  const amountContainer = document.getElementById('discountAmountContainer');
  const reasonContainer = document.getElementById('discountReasonContainer');

  discountedCheckbox.addEventListener('change', () => {
    const isVisible = discountedCheckbox.checked;
    amountContainer.classList.toggle('hidden', !isVisible);
    reasonContainer.classList.toggle('hidden', !isVisible);
  });
  function openVisitModal(patientId) {
    document.getElementById("visitPatientId").value = patientId;
    const modal = document.getElementById("visitModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  document.getElementById("closeVisitModal").addEventListener("click", () => {
    const modal = document.getElementById("visitModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  });

  window.addEventListener("click", (e) => {
    const modal = document.getElementById("visitModal");
    if (e.target === modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  });

  // Submit visit form via AJAX
  document.getElementById("visitForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);

    fetch(form.action, {
      method: "POST",
      headers: {
        "X-CSRFToken": formData.get("csrfmiddlewaretoken")
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(data.success);
        location.reload();
      } else if (data.warning) {
        if (confirm(data.warning + " View patient profile?")) {
          window.location.href = data.redirect_url;
        }
      } else if (data.error) {
        alert("Error: " + data.error);
      }
    })
    .catch(err => {
      alert("Unexpected error.");
      console.error(err);
    });
  });



  function openVisitModal(patientId) {
    document.getElementById("visitPatientId").value = patientId;
    const modal = document.getElementById("visitModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  document.getElementById("closeVisitModal").addEventListener("click", () => {
    const modal = document.getElementById("visitModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  });

  window.addEventListener("click", (e) => {
    const modal = document.getElementById("visitModal");
    if (e.target === modal) {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }
  });
</script>

{% endblock %}
