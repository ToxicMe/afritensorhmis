{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto mt-8 bg-white p-6 shadow rounded">
  <h2 class="text-2xl font-semibold mb-4">Triage Form</h2>

  <!-- Patient Info Card -->
  <div class="mb-6 p-4 border rounded bg-gray-50 shadow-sm">
    <p><strong>Name:</strong> {{ patient.patient_name }}</p>
    <p><strong>Gender:</strong> {{ patient.gender|capfirst }}</p>
    <p><strong>Age:</strong> 
    {% if age %}
        {{ age }} years
    {% else %}
        N/A
    {% endif %}
    </p>
  </div>

  <form method="post">
    {% csrf_token %}

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block font-semibold">BP (Systolic)</label>
        <input type="number" name="bp" value="{{ form_data.bp }}" class="w-full border rounded px-3 py-2" required>
      </div>

      <div>
        <label class="block font-semibold">BP (Diastolic)</label>
        <input type="number" name="bp_dia" value="{{ form_data.bp_dia }}" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="block font-semibold">Pulse Rate (PR)</label>
        <input type="number" name="pr" value="{{ form_data.pr }}" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="block font-semibold">SPO2 (%)</label>
        <input type="number" step="0.1" name="spo2" value="{{ form_data.spo2 }}" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="block font-semibold">Random Blood Sugar (RBS)</label>
        <input type="number" step="0.1" name="rbs" value="{{ form_data.rbs }}" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="block font-semibold">Temperature (°C)</label>
        <input type="number" step="0.1" name="temperature" value="{{ form_data.temperature }}" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="block font-semibold">Height (cm)</label>
        <input type="number" step="0.1" id="height" name="height" value="{{ form_data.height }}" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="block font-semibold">Weight (kg)</label>
        <input type="number" step="0.1" id="weight" name="weight" value="{{ form_data.weight }}" class="w-full border rounded px-3 py-2">
      </div>

      <div>
        <label class="block font-semibold">BMI</label>
        <input type="number" step="0.1" id="bmi" name="bmi" value="{{ form_data.bmi }}" class="w-full border rounded px-3 py-2 bg-gray-100" readonly>
        <p id="bmiWarning" class="text-sm mt-1 hidden"></p>
      </div>
    </div>

    <div class="mt-6">
      <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
        Submit Triage
      </button>
    </div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const heightInput = document.getElementById("height");
    const weightInput = document.getElementById("weight");
    const bmiInput = document.getElementById("bmi");
    const bmiWarning = document.getElementById("bmiWarning");

    function calculateBMI() {
      const h = parseFloat(heightInput.value) / 100; // cm → m
      const w = parseFloat(weightInput.value);

      if (h > 0 && w > 0) {
        const bmi = (w / (h * h)).toFixed(1);
        bmiInput.value = bmi;

        let message = "";
        let color = "text-gray-600";

        if (bmi < 18.5) {
          message = "Underweight";
          color = "text-red-600 font-semibold";
        } else if (bmi >= 25 && bmi < 30) {
          message = "Overweight";
          color = "text-yellow-600 font-semibold";
        } else if (bmi >= 30) {
          message = "Obese";
          color = "text-red-700 font-bold";
        } else {
          message = "Normal range";
          color = "text-green-600 font-medium";
        }

        bmiWarning.textContent = message;
        bmiWarning.className = `mt-1 text-sm ${color}`;
        bmiWarning.classList.remove("hidden");
      } else {
        bmiInput.value = "";
        bmiWarning.textContent = "";
        bmiWarning.classList.add("hidden");
      }
    }

    heightInput.addEventListener("input", calculateBMI);
    weightInput.addEventListener("input", calculateBMI);
  });
</script>
{% endblock %}
