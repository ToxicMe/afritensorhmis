{% extends 'base.html' %}

{% block content %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  const paymentForm = document.querySelector('form[action*="mark_bills_paid"]');
  const loader = document.getElementById('paymentLoader');

  if (paymentForm) {
    paymentForm.addEventListener('submit', () => {
      loader.classList.remove('hidden');
    });
  }
});
</script>


<!-- Loader Overlay -->
<div id="paymentLoader" class="hidden fixed inset-0 bg-black bg-opacity-40 z-[1100] flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-md text-center">
    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <p class="text-sm text-gray-700 font-medium">Processing Payment, please wait...</p>
  </div>
</div>


<div id="receipt-section" class="max-w-6xl mx-auto p-6 mt-12 bg-white shadow rounded relative print:p-0 print:shadow-none print:mt-0 print:max-w-full">

  <!-- Hidden on Print -->
  <div class="absolute top-4 right-4 no-print">
    <button onclick="printReceipt()" class="bg-blue-800 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded shadow">
      Print PDF
    </button>
  </div>

  <h2 class="text-2xl font-bold mb-4">Bill Receipt</h2>

  <div class="mb-6">
    <p><strong>Patient Name:</strong> {{ patient.patient_name|title }}</p>
    <p><strong>Gender:</strong> {{ patient_gender }}</p>
    <p><strong>Age:</strong> {{ patient_age }}</p>
    <p><strong>Visit:</strong> {{ visit.tracking_code }}</p>
    <p><strong>Visit Date:</strong> {{ visit.date_time|date:"Y-m-d H:i" }}</p>
  </div>

  <table class="w-full table-auto border border-gray-300 text-sm mb-6">
    <thead class="bg-gray-100">
      <tr>
        <th class="border px-4 py-2 text-left">Date</th>
        <th class="border px-4 py-2 text-left">Description</th>
        <th class="border px-4 py-2 text-left">Amount (KSh)</th>
        <th class="border px-4 py-2 text-left">Status</th>
        <th class="border px-4 py-2 text-left"></th>
      </tr>
    </thead>
    <tbody>
      {% for bill in bills %}
      <tr>
        <td class="border px-4 py-2">{{ bill.date|date:"Y-m-d H:i" }}</td>
        <td class="border px-4 py-2">{{ bill.description }}</td>
        
    <td class="border px-4 py-2">
  {% if bill.discounted %}
    <span class="text-green-700 font-semibold">KSh {{ bill.discounted_amount }}</span>
  {% else %}
    KSh {{ bill.amount }}
  {% endif %}
</td>


        <td class="border px-4 py-2">{{ bill.status|capfirst }}</td>
        <td class="border px-4 py-2">
          <a href="" class="text-blue-600 hover:underline">Dispute</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="text-right mt-6">
    <p class="text-lg font-bold text-green-700">Total Amount: KSh {{ total_amount }}</p>
  </div>

  <!-- Pay Button (Hidden on Print) -->
  <div class="text-right mt-6 mb-6 no-print">
    
    <button id="openModal" type="button"
        class="mt-4 mx-auto block px-4 py-2 rounded-lg text-white text-sm font-medium border-none outline-none tracking-wide bg-blue-600 hover:bg-blue-700 active:bg-blue-600">PAY</button>
</div>
  </div>

</div>


        <!-- MODAL -->

        <div>
            <div id="modal">
                <div
                    class="fixed inset-0 p-4 flex flex-wrap justify-center items-center w-full h-full z-[1000] before:fixed before:inset-0 before:w-full before:h-full before:bg-[rgba(0,0,0,0.5)] overflow-auto">
                    <div class="w-full max-w-lg bg-white shadow-lg rounded-lg p-8 relative">
                        <div class="flex items-center">
                            <h3 class="text-blue-600 text-xl font-semibold flex-1">Payment Details</h3>
                            <svg id="closeIcon" xmlns="http://www.w3.org/2000/svg"
                                class="w-3.5 h-3.5 ml-2 cursor-pointer shrink-0 fill-gray-400 hover:fill-red-500"
                                viewBox="0 0 320.591 320.591">
                                <path
                                    d="M30.391 318.583a30.37 30.37 0 0 1-21.56-7.288c-11.774-11.844-11.774-30.973 0-42.817L266.643 10.665c12.246-11.459 31.462-10.822 42.921 1.424 10.362 11.074 10.966 28.095 1.414 39.875L51.647 311.295a30.366 30.366 0 0 1-21.256 7.288z"
                                    data-original="#000000"></path>
                                <path
                                    d="M287.9 318.583a30.37 30.37 0 0 1-21.257-8.806L8.83 51.963C-2.078 39.225-.595 20.055 12.143 9.146c11.369-9.736 28.136-9.736 39.504 0l259.331 257.813c12.243 11.462 12.876 30.679 1.414 42.922-.456.487-.927.958-1.414 1.414a30.368 30.368 0 0 1-23.078 7.288z"
                                    data-original="#000000"></path>
                            </svg>
                        </div>

                        <form method="post" action="{% url 'mark_bills_paid' visit.tracking_code %}" class="space-y-6 mt-8">
            {% csrf_token %}

            <input type="hidden" name="payment_method" id="selectedPaymentMethod" value="cash" /> <!-- default to cash -->

            <div>
                <label class="text-slate-900 text-sm mb-2 block">Visit ID</label>
                <input type="text" value="{{ visit.tracking_code }}" readonly
                    class="px-4 py-3 bg-gray-100 w-full rounded-lg" />
            </div>

            <div>
                <label class="text-slate-900 text-sm mb-2 block">Patient Name</label>
                <input type="text" value="{{ patient.patient_name|title }}" readonly
                    class="px-4 py-3 bg-gray-100 w-full rounded-lg" />
            </div>

            <div>
                <label class="text-slate-900 text-sm mb-2 block">Date</label>
                <input type="text" value="{{ visit.date_time|date:'Y-m-d H:i' }}" readonly
                    class="px-4 py-3 bg-gray-100 w-full rounded-lg" />
            </div>

            <!-- Payment Method Dropdown -->
            <div class="relative w-max mt-6 mb-6 mx-auto">
                <button type="button" id="dropdownToggle"
                    class="px-5 py-2.5 rounded-sm text-white bg-blue-600 hover:bg-blue-700 text-sm font-medium">
                    Choose Payment Method
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 fill-white inline ml-3" viewBox="0 0 24 24">
                        <path fill-rule="evenodd"
                            d="M11.99997 18.1669a2.38 2.38 0 0 1-1.68266-.69733l-9.52-9.52a2.38 2.38 0 1 1 3.36532-3.36532l7.83734 7.83734 7.83734-7.83734a2.38 2.38 0 1 1 3.36532 3.36532l-9.52 9.52a2.38 2.38 0 0 1-1.68266.69734z"
                            clip-rule="evenodd" />
                    </svg>
                </button>

                <ul id="dropdownMenu" class="hidden absolute z-50 bg-white shadow-lg py-2 rounded-sm mt-2 min-w-[180px]">
                    <li class="dropdown-item py-2.5 px-4 hover:bg-slate-100 cursor-pointer" data-method="mpesa">Mpesa</li>
                    <li class="dropdown-item py-2.5 px-4 hover:bg-slate-100 cursor-pointer" data-method="insurance">Insurance</li>
                    <li class="dropdown-item py-2.5 px-4 hover:bg-slate-100 cursor-pointer" data-method="cash">Cash</li>
                    <li class="dropdown-item py-2.5 px-4 hover:bg-slate-100 cursor-pointer" data-method="other">Others</li>
                </ul>
            </div>

            <div>
                <label class="text-slate-900 text-sm mb-2 block">Phone Number</label>
                <input type="tel" value="{{ patient.phone_number }}" readonly
                    class="px-4 py-3 bg-gray-100 w-full rounded-lg" />
            </div>

            <!-- Modal Buttons -->
            <div class="flex justify-end gap-4 mt-8">
                <button id="closeButton" type="button"
                    class="px-6 py-3 rounded-lg text-slate-900 bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button type="submit"
                    class="px-6 py-3 rounded-lg text-white bg-blue-600 hover:bg-blue-700">Pay</button>
            </div>
        </form>


                          

                    
                    


                    

                    
                    
            </div>
        </div>
    </div>






<!-- MODAL -->

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dropdownItems = document.querySelectorAll('.dropdown-item');
    const hiddenInput = document.getElementById('selectedPaymentMethod');

    document.querySelectorAll('.dropdown-item').forEach(item => {
      item.addEventListener('click', () => {
        hiddenInput.value = item.getAttribute('data-method');
      });
    });
    const dropdownToggle = document.getElementById('dropdownToggle');

    dropdownItems.forEach(item => {
      item.addEventListener('click', () => {
        const method = item.getAttribute('data-method');
        hiddenInput.value = method;
        dropdownToggle.innerHTML = `Payment: ${method.charAt(0).toUpperCase() + method.slice(1)} <svg xmlns="http://www.w3.org/2000/svg" class="w-3 fill-white inline ml-3" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M11.99997 18.1669a2.38 2.38 0 0 1-1.68266-.69733l-9.52-9.52a2.38 2.38 0 1 1 3.36532-3.36532l7.83734 7.83734 7.83734-7.83734a2.38 2.38 0 1 1 3.36532 3.36532l-9.52 9.52a2.38 2.38 0 0 1-1.68266.69734z" clip-rule="evenodd"/></svg>`;
      });
    });
  });
</script>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        let dropdownToggle = document.getElementById('dropdownToggle');
        let dropdownMenu = document.getElementById('dropdownMenu');

        function toggleDropdown() {
            dropdownMenu.classList.toggle('hidden');
            dropdownMenu.classList.toggle('block');
        }

        function hideDropdown() {
            dropdownMenu.classList.add('hidden');
            dropdownMenu.classList.remove('block');
        }

        dropdownToggle.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevents triggering document click
            toggleDropdown();
        });

        // Hide dropdown when <li> is clicked
        dropdownMenu.querySelectorAll('.dropdown-item').forEach((li) => {
            li.addEventListener('click', () => {
                hideDropdown();
            });
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!dropdownMenu.contains(event.target) && event.target !== dropdownToggle) {
                hideDropdown();
            }
        });
    });
</script>








<!-- Print Script -->
<script>
function printReceipt() {
  window.print();
}


document.addEventListener('DOMContentLoaded', () => {
    let modal = document.getElementById('modal');
    let openModalBtn = document.getElementById('openModal');
    let closeModalBtns = [document.getElementById('closeIcon'), document.getElementById('closeButton')];

    function showModal() {
        modal.classList.remove('hidden');
    }

    function hideModal() {
        modal.classList.add('hidden');
    }

    openModalBtn.addEventListener('click', showModal);

    closeModalBtns.forEach(btn => btn.addEventListener('click', hideModal));

    // Close modal when clicking outside the modal content
    modal.addEventListener('click', (event) => {
        if (event.target === modal.firstElementChild) {
            hideModal();
        }
    });
});
</script>

<!-- Hide Extra Layout on Print -->
<style>
  @media print {
    body * {
      visibility: hidden;
    }
    #receipt-section, #receipt-section * {
      visibility: visible;
    }
    #receipt-section {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      box-shadow: none;
    }

    /* Hide navigation, buttons, links, footers */
    .no-print {
      display: none !important;
    }

    /* Avoid page margins or scrollbars */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: white;
    }
  }
</style>
{% endblock %}
